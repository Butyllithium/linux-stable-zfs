name: build linux kernel with openzfs

on:
  push:
    branches: "*"

jobs:
  build:
    runs-on: ubuntu-latest
    container: archlinux:base-devel

    steps:
    - name: Checkout repository
      uses: actions/checkout@main

    - name: Initialization environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install $(curl -fsSL git.io/depends-ubuntu-1804)
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir

    - name: Install dependencies
      run: |
        pacman -Syu --noconfirm
        pacman -S --noconfirm git base-devel python cpio pahole bc libelf perl xz

    - name: Show PKGBUILD content
      run: |
        pwd
        ls -la
        cat PKGBUILD

    - name: Build package
      run: |
        useradd builder -m
        chown -R builder:builder .
        cd "$GITHUB_WORKSPACE"
        su builder -c 'makepkg -sf --noconfirm --skippgpcheck --skipchecksums'

    - name: List built packages
      run: |
        ls -la *.pkg.tar.zst

    - name: Upload package artifacts
      uses: actions/upload-artifact@v4
      with:
        name: packages
        path: ./*.pkg.tar.zst
        retention-days: 90
